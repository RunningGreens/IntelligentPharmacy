<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//ibatis.apache.org//DTD Mapper 3.0//EN"
		"http://ibatis.apache.org/dtd/ibatis-3-mapper.dtd">

<mapper namespace="com.cy.mapper.AlarmDrugManager">


	<!--查询登录账号的角色ID-->
	<select id="selectRoleName" parameterType="com.cy.bean.Admin" resultType="com.cy.bean.Admin">
		select ADMINROLEID from ADMIN_TABLE where ADMINNAME =#{adminName}
	</select>

	<!--添加信息到报警表-->
	<insert id="addAlarm" parameterType="com.cy.bean.Alarm" >
		<selectKey keyProperty="alarmId" order="BEFORE" resultType="java.lang.Integer">
			select ALARM_TABLE_SEQUENCE.nextval from dual
		</selectKey>
		insert into ALARM_TABLE (alarmId,alarmStyleId,alarmRole,alarmDetails,alarmDate,alarmState)
		values(#{alarmId},#{alarmStyleId},#{alarmRole},#{alarmDetails},to_char(sysdate,'YYYY-MM-DD HH24:MI:SS'),0)
	</insert>

	<!--查询报警所有信息-->
	<select id="selectAlarmList" parameterType="com.cy.bean.Alarm" resultType="com.cy.bean.Alarm" >
		select a.alarmId,a.alarmStyleId,a.alarmRole,a.alarmDetails,a.alarmDate,a.alarmState from ALARM_TABLE a  where 1=1 and a.alarmState=0 Order by a.alarmDate
	</select>

	<!--查询低限药品数量-->
	<select id="selectAlarmNum"  parameterType="com.cy.bean.PhamacyDrug" resultType="com.cy.bean.PhamacyDrug">
		select a.*,b.DRUGCLASSIFICATIONNAME from PHARMACY_TABLE a , DRUG_CLASSIFICATION_TABLE b where <![CDATA[DRUGQUANTITY<=99]]> and a.DRUGCLASSIFICATIONID=b.DRUGCLASSIFICATIONID
	</select>

	<!--查询过期药品数量-->
	<select id="selectAlarmExpired"  parameterType="com.cy.bean.PhamacyDrug" resultType="com.cy.bean.PhamacyDrug" >
		select a.*,b.DRUGCLASSIFICATIONNAME from PHARMACY_TABLE a , DRUG_CLASSIFICATION_TABLE b where <![CDATA[VALIDAITYPERIOD <= to_char(sysdate, 'yyyy-mm-dd')]]> and a.DRUGCLASSIFICATIONID=b.DRUGCLASSIFICATIONID
	</select>

	<!--查看报警消息，更改状态-->
	<update id="seeDetails" parameterType="java.lang.Integer">
		update ALARM_TABLE set alarmState=1 where alarmId=#{alarmId}
    </update>

</mapper>
	
	